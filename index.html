<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K线拾亿人-量化系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        @media (min-width: 1024px) {
            body {
                max-width: 1200px;
                margin: 20px auto;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                background-color: white;
                min-height: calc(100vh - 40px);
            }
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #f5f7fa;
                z-index: -1;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .header h1 {
            margin-bottom: 6px;
            font-size: 1.5rem;
        }
        .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 3px;
        }
        .current-time {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.8rem;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .current-time {
                position: relative;
                top: auto;
                right: auto;
                display: block;
                margin-top: 8px;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e5799;
            margin: 6px 0;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .controls {
            display: flex;
            margin-bottom: 15px;
        }
        button {
            padding: 12px 16px;
            background-color: #1e5799;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            font-size: 0.9rem;
        }
        button:hover {
            background-color: #16437e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #lastUpdate {
            margin-top: 12px;
            font-style: italic;
            color: #6c757d;
            text-align: center;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .data-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
        }
        .data-panel h2 {
            color: #1e5799;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
        }
        .data-panel h2 i {
            color: #207cca;
        }
        .data-section {
            overflow-y: visible;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            min-height: 60px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }
        th, td {
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
            font-size: 0.85rem;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            text-align: center;
        }
        th:hover {
            background-color: #e9ecef;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .cell-index {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 6px 2px;
        }
        .cell-index .cell-main {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .cell-double {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 6px 2px;
        }
        .cell-main {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.85rem;
        }
        .cell-sub {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .cell-name {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 6px 2px;
        }
        .name-main {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .name-sub {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .chi-next-badge {
            color: #e74c3c;
            font-size: 0.7rem;
        }
        .positive {
            color: #e74c3c;
            font-weight: 600;
        }
        .negative {
            color: #2ecc71;
            font-weight: 600;
        }
        .moderate-up {
            color: #1890ff;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 8px;
            color: #adb5bd;
        }
        .empty-state.special {
            background-color: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        .empty-state.special h3 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .empty-state.special p {
            color: #856404;
            font-size: 0.85rem;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 12px;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 0.8rem;
            padding-bottom: 15px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        .status-indicator.updated {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-indicator.not-updated {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            .header {
                padding: 10px;
                margin-bottom: 12px;
            }
            .header h1 {
                font-size: 1.3rem;
            }
            .stats {
                gap: 8px;
                margin-bottom: 12px;
            }
            .stat-box {
                padding: 10px;
            }
            .stat-value {
                font-size: 1.3rem;
            }
            .controls {
                margin-bottom: 12px;
            }
            button {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            .data-panel {
                padding: 12px;
                margin-bottom: 12px;
            }
            .data-panel h2 {
                font-size: 1.1rem;
            }
            th, td {
                padding: 6px 2px;
                font-size: 0.75rem;
            }
            .cell-index, .cell-double, .cell-name {
                padding: 5px 1px;
            }
            .cell-main, .name-main {
                font-size: 0.75rem;
            }
            .cell-sub, .name-sub {
                font-size: 0.7rem;
            }
            .chi-next-badge {
                font-size: 0.65rem;
            }
        }
        
        @media (min-width: 1024px) {
            .header {
                padding: 15px;
                margin-bottom: 20px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .subtitle {
                font-size: 0.9rem;
            }
            .current-time {
                font-size: 0.9rem;
                padding: 6px 12px;
                top: 15px;
                right: 20px;
            }
            .stats {
                gap: 15px;
                margin-bottom: 20px;
            }
            .stat-box {
                padding: 15px;
            }
            .stat-value {
                font-size: 1.8rem;
            }
            .stat-label {
                font-size: 0.9rem;
            }
            .controls {
                margin-bottom: 20px;
            }
            button {
                padding: 14px 20px;
                font-size: 1rem;
            }
            .data-panel {
                padding: 20px;
                margin-bottom: 20px;
            }
            .data-panel h2 {
                font-size: 1.4rem;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }
            th, td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
            .cell-index, .cell-double, .cell-name {
                padding: 8px 4px;
            }
            .cell-main, .name-main {
                font-size: 0.9rem;
            }
            .cell-sub, .name-sub {
                font-size: 0.8rem;
            }
            .chi-next-badge {
                font-size: 0.8rem;
            }
            .status-indicator {
                font-size: 0.85rem;
                padding: 4px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            th, td {
                padding: 5px 1px;
                font-size: 0.7rem;
            }
            .cell-main, .name-main {
                font-size: 0.7rem;
            }
            .cell-sub, .name-sub {
                font-size: 0.65rem;
            }
            .chi-next-badge {
                font-size: 0.6rem;
            }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e5799;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> K线拾亿人-量化系统</h1>
        <div class="subtitle">交易日9:27分前后更新当天数据</div>
        <div class="current-time" id="currentTime">--:--:--</div>
    </div>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-label">观察个股数量</div>
            <div class="stat-value" id="patternCount">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">最后更新</div>
            <div class="stat-value" id="lastUpdateTime">--:--</div>
        </div>
    </div>

    <div class="controls">
        <button id="fetchAllDataBtn">
            <i class="fas fa-sync-alt"></i> 更新全部数据
        </button>
    </div>

    <div id="lastUpdate"></div>

    <div class="data-panel">
        <div class="panel-header">
            <div class="panel-title">
                <h2><i class="fas fa-filter"></i> 重点观察</h2>
                <span class="status-indicator not-updated" id="patternStatus">未更新</span>
            </div>
        </div>
        <div class="data-section">
            <table id="patternTable" class="pattern-table">
                <thead>
                    <tr>
                        <th data-sort="index">序号<i class="fas fa-sort"></i></th>
                        <th data-sort="name">名称<i class="fas fa-sort"></i></th>
                        <th data-sort="bidIncrease">观察涨幅/竞额<i class="fas fa-sort"></i></th>
                        <th data-sort="currentIncrease">现涨/盈亏<i class="fas fa-sort"></i></th>
                        <th data-sort="industry">概念（市值）<i class="fas fa-sort"></i></th>
                    </tr>
                </thead>
                <tbody id="patternTableBody">
                    <tr><td colspan="5" class="empty-state special" id="patternEmptyState">
                        <i class="fas fa-search"></i>
                        <h3>暂无符合筛选条件的个股</h3>
                        <p>请获取数据后查看筛选结果</p>
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="data-panel">
        <div class="panel-header">
            <div class="panel-title">
                <h2><i class="fas fa-table"></i> 常规观察</h2>
                <span class="status-indicator not-updated" id="qiangchouStatus">未更新</span>
            </div>
        </div>
        <div class="data-section">
            <table id="qiangchouTable" class="qiangchou-table">
                <thead>
                    <tr>
                        <th data-sort="index">序号<i class="fas fa-sort"></i></th>
                        <th data-sort="name">名称<i class="fas fa-sort"></i></th>
                        <th data-sort="bidIncrease">观察涨幅/竞额<i class="fas fa-sort"></i></th>
                        <th data-sort="currentIncrease">现涨/盈亏<i class="fas fa-sort"></i></th>
                        <th data-sort="industry">概念（市值）<i class="fas fa-sort"></i></th>
                    </tr>
                </thead>
                <tbody id="qiangchouTableBody">
                    <tr><td colspan="5" class="empty-state">数据加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <p>K线拾亿人-量化系统 &copy; 2025 | 版权所有</p>
        <p>本工具仅用于数据查看，不构成任何投资建议</p>
    </div>

    <script>
        let currentData = { qiangchou: [] };
        let patternData = [];
        let sortStates = { qiangchou: {}, pattern: {} };
        let qiangchouLastUpdated = null;
        let patternLastUpdated = null;
        let isQiangchouDataLoaded = false;
        let isPatternDataLoaded = false;
        let timeInterval = null;
        
        const filterConfig = {
            bidIncrease: {
                min: 5,
                max: 8
            },
            bidGrabMin: 5,
            range1: {
                minAmount: 1000,
                maxAmount: 3000
            },
            range2: {
                minAmount: 1700,
                maxAmount: 6000
            },
            onlyChiNext: true
        };
        
        const getEncryptedApiUrl = function() {
            const encodedFragments = [
                "aHR0cHM6Ly",
                "9tLmR1YW4",
                "eGlhbnhp",
                "YS5jb20v",
                "ZGF0YS8",
                "Z2V0UW",
                "lYW5nY2h",
                "vdURhdGEv",
                "MTE="
            ];
            
            let base64Url = "";
            for (let i = 0; i < encodedFragments.length; i++) {
                base64Url += encodedFragments[i];
            }
            
            let decodedUrl = atob(base64Url);
            
            const charMap = {
                'a': 'x', 'x': 'a',
                'm': 'n', 'n': 'm',
                't': 'p', 'p': 't',
                's': 'q', 'q': 's'
            };
            
            let finalUrl = '';
            for (let i = 0; i < decodedUrl.length; i++) {
                const char = decodedUrl[i];
                finalUrl += charMap[char] || char;
            }
            
            const reverseCharMap = {};
            for (const key in charMap) {
                reverseCharMap[charMap[key]] = key;
            }
            
            let realUrl = '';
            for (let i = 0; i < finalUrl.length; i++) {
                const char = finalUrl[i];
                realUrl += reverseCharMap[char] || char;
            }
            
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 8);
            return `${realUrl}?_=${timestamp}&r=${randomStr}`;
        };
        
        const generateRequestHeaders = function() {
            return {
                'Accept': 'application/json, text/plain, */*',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            };
        };
        
        const validateResponseData = function(data) {
            try {
                if (!data || typeof data !== 'object') {
                    return false;
                }
                
                if (!data.list || typeof data.list !== 'object') {
                    return false;
                }
                
                if (!Array.isArray(data.list.qiangchou)) {
                    return false;
                }
                
                if (data.list.qiangchou.length > 0) {
                    const firstItem = data.list.qiangchou[0];
                    if (!Array.isArray(firstItem) || firstItem.length < 8) {
                        return false;
                    }
                }
                
                return true;
            } catch (error) {
                console.warn('数据验证失败:', error.message);
                return false;
            }
        };
        
        const secureFetch = async function(url, options = {}) {
            try {
                await new Promise(resolve => setTimeout(resolve, 50));
                
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!validateResponseData(data)) {
                    throw new Error('数据验证失败');
                }
                
                return data;
            } catch (error) {
                console.warn('请求失败:', error.message);
                throw error;
            }
        };
        
        const getFallbackApiUrl = function() {
            const fragments = [
                "https://m.duanxianxia.com",
                "/data/getQiangchouData/11"
            ];
            
            const timestamp = Date.now();
            return fragments.join('') + `?t=${timestamp}`;
        };

        document.addEventListener('DOMContentLoaded', function() {
            init();
        });

        function init() {
            document.getElementById('fetchAllDataBtn').addEventListener('click', fetchAllData);
            
            document.querySelectorAll('#qiangchouTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const sortKey = this.getAttribute('data-sort');
                    sortTable('qiangchou', sortKey);
                });
            });
            
            document.querySelectorAll('#patternTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const sortKey = this.getAttribute('data-sort');
                    sortTable('pattern', sortKey);
                });
            });
            
            setTimeout(() => {
                fetchAllData();
            }, 500);
            
            updateCurrentTime();
            timeInterval = setInterval(updateCurrentTime, 1000);
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        async function fetchAllData() {
            const btn = document.getElementById('fetchAllDataBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
                btn.disabled = true;
                
                await fetchData();
                
                showMessage('全部数据更新成功！', 'success');
            } catch (error) {
                console.error('获取全部数据时出错:', error);
                showMessage(`获取全部数据失败: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function fetchData() {
            let data = null;
            let error = null;
            
            try {
                const apiUrl = getEncryptedApiUrl();
                const headers = generateRequestHeaders();
                
                data = await secureFetch(apiUrl, { headers });
                console.log('通过混淆API获取数据成功');
            } catch (err1) {
                console.log('混淆API失败，尝试备用API...');
                error = err1;
                
                try {
                    const fallbackUrl = getFallbackApiUrl();
                    const headers = generateRequestHeaders();
                    
                    data = await secureFetch(fallbackUrl, { headers });
                    console.log('通过备用API获取数据成功');
                } catch (err2) {
                    console.log('备用API失败，尝试原始API...');
                    error = err2;
                    
                    try {
                        const originalUrl = 'https://m.duanxianxia.com/data/getQiangchouData/11?_t=' + Date.now();
                        data = await fetch(originalUrl).then(res => res.json());
                        
                        if (validateResponseData(data)) {
                            console.log('通过原始API获取数据成功');
                        } else {
                            throw new Error('原始API数据验证失败');
                        }
                    } catch (err3) {
                        error = err3;
                        console.error('所有API尝试都失败:', error);
                    }
                }
            }
            
            if (data && validateResponseData(data)) {
                processData(data);
                
                filterPatternStocks();
                
                updateTable();
                updatePatternTable();
                updateStats();
                
                updateModuleStatus('qiangchou', '已更新');
                updateModuleStatus('pattern', '已更新');
            } else {
                useFallbackData();
            }
        }

        function useFallbackData() {
            try {
                const fallbackData = {
                    "list": {
                        "qiangchou": [
                            ["301449","N天溯计量",14.1,null,7.34,"-5.20","2263","锂电池","7.34","2263",null,"6.83"],
                            ["300973","立高食品",51.4,null,8.4,"2.82","1545","乳业","8.40","1545",null,"7.51"],
                            ["920786","骑士乳业",15.8,null,7.34,"-5.20","2263","农业种植","7.34","2263",null,"6.83"],
                            ["300123","亚光科技",32.5,null,6.8,"1.25","1890","芯片","6.80","1890",null,"5.45"],
                            ["300456","赛微电子",45.2,null,5.6,"-2.15","2100","半导体","5.60","2100",null,"4.32"]
                        ]
                    }
                };
                
                if (validateResponseData(fallbackData)) {
                    processData(fallbackData);
                    filterPatternStocks();
                    updateTable();
                    updatePatternTable();
                    updateStats();
                    
                    updateModuleStatus('qiangchou', '已更新');
                    updateModuleStatus('pattern', '已更新');
                    
                    showMessage('已使用示例数据，网络请求可能受限', 'warning');
                } else {
                    throw new Error('示例数据验证失败');
                }
            } catch (fallbackError) {
                showMessage('无法加载任何数据，请检查网络连接', 'error');
                console.error('所有数据源都失败:', fallbackError);
            }
        }

        function processData(data) {
            currentData.qiangchou = data.list.qiangchou || [];
            isQiangchouDataLoaded = true;
            qiangchouLastUpdated = new Date();
            
            updateLastUpdateTime();
        }

        function filterPatternStocks() {
            patternData = [];
            
            if (!currentData.qiangchou || currentData.qiangchou.length === 0) {
                return;
            }
            
            currentData.qiangchou.forEach((item, index) => {
                const stockCode = String(item[0]);
                const bidIncrease = parseFloat(item[4]);
                const bidGrab = parseFloat(item[11]);
                const bidAmount = parseFloat(item[6]);
                
                const condition1 = bidIncrease >= filterConfig.bidIncrease.min && 
                                  bidIncrease <= filterConfig.bidIncrease.max;
                
                const condition2 = bidGrab >= filterConfig.bidGrabMin;
                
                let condition3 = false;
                
                if (bidIncrease >= 5 && bidIncrease <= 6) {
                    condition3 = bidAmount >= filterConfig.range1.minAmount && 
                                bidAmount <= filterConfig.range1.maxAmount;
                } else if (bidIncrease > 6 && bidIncrease <= 8) {
                    condition3 = bidAmount >= filterConfig.range2.minAmount && 
                                bidAmount <= filterConfig.range2.maxAmount;
                }
                
                let condition4 = true;
                if (filterConfig.onlyChiNext) {
                    condition4 = stockCode.startsWith('30');
                }
                
                if (condition1 && condition2 && condition3 && condition4) {
                    item.index = patternData.length + 1;
                    patternData.push(item);
                }
            });
            
            isPatternDataLoaded = true;
            patternLastUpdated = new Date();
        }

        function updateTable() {
            const tableBody = document.getElementById('qiangchouTableBody');
            const data = currentData.qiangchou;
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-state">暂无适合个股</td></tr>`;
                return;
            }
            
            let html = '';
            
            data.forEach((item, index) => {
                const code = item[0] || '--';
                const name = item[1] || '--';
                const marketValue = item[2] ? parseFloat(item[2]).toFixed(1) + '亿' : '--';
                const bidIncrease = item[4] ? parseFloat(item[4]).toFixed(2) : 0;
                let currentIncrease = item[5] || 0;
                const bidAmount = item[6] ? item[6] + '万' : '--';
                const industry = item[7] || '--';
                const bidGrab = item[11] ? parseFloat(item[11]).toFixed(2) + '%' : '--';
                
                const isChiNext = code.startsWith('30');
                
                let profitLoss = '--';
                let profitLossClass = '';
                
                if (currentIncrease !== '--' && bidIncrease !== '--') {
                    const currentValue = parseFloat(currentIncrease);
                    const bidValue = parseFloat(bidIncrease);
                    const plValue = currentValue - bidValue;
                    profitLoss = (plValue >= 0 ? '+' : '') + plValue.toFixed(2) + '%';
                    
                    if (plValue > 0) {
                        profitLossClass = 'positive';
                    } else if (plValue < 0) {
                        profitLossClass = 'negative';
                    }
                }
                
                let currentIncreaseFormatted = '--';
                let currentIncreaseClass = '';
                if (currentIncrease !== '--') {
                    const changeValue = parseFloat(currentIncrease);
                    currentIncreaseFormatted = (changeValue >= 0 ? '+' : '') + changeValue.toFixed(2) + '%';
                    if (changeValue > 0) {
                        currentIncreaseClass = 'positive';
                    } else if (changeValue < 0) {
                        currentIncreaseClass = 'negative';
                    }
                }
                
                const bidIncreaseFormatted = bidIncrease !== '--' ? bidIncrease + '%' : '--';
                
                html += `
                <tr>
                    <td class="cell-index">
                        <div class="cell-main">${index + 1}</div>
                    </td>
                    <td>
                        <div class="cell-name">
                            <div class="name-main">
                                ${isChiNext ? '<i class="fas fa-check chi-next-badge"></i>' : ''}
                                ${name}
                            </div>
                            <div class="name-sub">${code}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-double">
                            <div class="cell-main">${bidIncreaseFormatted}</div>
                            <div class="cell-sub">${bidAmount}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-double">
                            <div class="cell-main ${currentIncreaseClass}">${currentIncreaseFormatted}</div>
                            <div class="cell-sub ${profitLossClass}">${profitLoss}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-double">
                            <div class="cell-main">${industry}</div>
                            <div class="cell-sub">${marketValue}</div>
                        </div>
                    </td>
                </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function updatePatternTable() {
            const tableBody = document.getElementById('patternTableBody');
            
            if (!patternData || patternData.length === 0) {
                tableBody.innerHTML = `
                <tr><td colspan="5" class="empty-state special">
                    <i class="fas fa-calendar-times"></i>
                    <h3>无适合个股，建议空仓等待</h3>
                </td></tr>`;
                return;
            }
            
            let html = '';
            
            patternData.forEach((item, index) => {
                const code = item[0] || '--';
                const name = item[1] || '--';
                const marketValue = item[2] ? parseFloat(item[2]).toFixed(1) + '亿' : '--';
                const bidIncrease = item[4] ? parseFloat(item[4]).toFixed(2) : 0;
                let currentIncrease = item[5] || 0;
                const bidAmount = item[6] ? item[6] + '万' : '--';
                const industry = item[7] || '--';
                const bidGrab = item[11] ? parseFloat(item[11]).toFixed(2) + '%' : '--';
                
                const isChiNext = code.startsWith('30');
                
                let profitLoss = '--';
                let profitLossClass = '';
                
                if (currentIncrease !== '--' && bidIncrease !== '--') {
                    const currentValue = parseFloat(currentIncrease);
                    const bidValue = parseFloat(bidIncrease);
                    const plValue = currentValue - bidValue;
                    profitLoss = (plValue >= 0 ? '+' : '') + plValue.toFixed(2) + '%';
                    
                    if (plValue > 0) {
                        profitLossClass = 'positive';
                    } else if (plValue < 0) {
                        profitLossClass = 'negative';
                    }
                }
                
                let currentIncreaseFormatted = '--';
                let currentIncreaseClass = '';
                if (currentIncrease !== '--') {
                    const changeValue = parseFloat(currentIncrease);
                    currentIncreaseFormatted = (changeValue >= 0 ? '+' : '') + changeValue.toFixed(2) + '%';
                    if (changeValue > 0) {
                        currentIncreaseClass = 'positive';
                    } else if (changeValue < 0) {
                        currentIncreaseClass = 'negative';
                    }
                }
                
                const bidIncreaseFormatted = bidIncrease !== '--' ? bidIncrease + '%' : '--';
                
                html += `
                <tr>
                    <td class="cell-index">
                        <div class="cell-main">${index + 1}</div>
                    </td>
                    <td>
                        <div class="cell-name">
                            <div class="name-main">
                                ${isChiNext ? '<i class="fas fa-check chi-next-badge"></i>' : ''}
                                ${name}
                            </div>
                            <div class="name-sub">${code}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-double">
                            <div class="cell-main">${bidIncreaseFormatted}</div>
                            <div class="cell-sub">${bidAmount}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-double">
                            <div class="cell-main ${currentIncreaseClass}">${currentIncreaseFormatted}</div>
                            <div class="cell-sub ${profitLossClass}">${profitLoss}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-double">
                            <div class="cell-main">${industry}</div>
                            <div class="cell-sub">${marketValue}</div>
                        </div>
                    </td>
                </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function updateModuleStatus(module, status) {
            let statusElement;
            let lastUpdated;
            
            switch(module) {
                case 'pattern':
                    statusElement = document.getElementById('patternStatus');
                    lastUpdated = patternLastUpdated;
                    break;
                case 'qiangchou':
                    statusElement = document.getElementById('qiangchouStatus');
                    lastUpdated = qiangchouLastUpdated;
                    break;
                default:
                    return;
            }
            
            if (status === '已更新') {
                statusElement.textContent = '已更新';
                statusElement.className = 'status-indicator updated';
                
                if (lastUpdated) {
                    const timeString = lastUpdated.toLocaleTimeString('zh-CN', { 
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    statusElement.title = `上次更新: ${timeString}`;
                }
            } else {
                statusElement.textContent = '未更新';
                statusElement.className = 'status-indicator not-updated';
                statusElement.title = '数据尚未更新';
            }
        }

        function updateStats() {
            const patternCount = patternData ? patternData.length : 0;
            const patternCountElement = document.getElementById('patternCount');
            
            if (patternCount === 0) {
                patternCountElement.textContent = '空仓';
                patternCountElement.style.color = '#6c757d';
            } else {
                patternCountElement.textContent = patternCount;
                patternCountElement.style.color = '#1e5799';
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('zh-CN');
            
            document.getElementById('lastUpdate').innerHTML = 
                `<i class="far fa-clock"></i> 最后更新: ${dateString} ${timeString}`;
            
            document.getElementById('lastUpdateTime').textContent = 
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }

        function sortTable(type, key) {
            let data;
            if (type === 'qiangchou') {
                data = currentData.qiangchou;
            } else if (type === 'pattern') {
                data = patternData;
            } else {
                return;
            }
            
            if (!data || data.length === 0) return;
            
            if (!sortStates[type][key]) {
                sortStates[type][key] = 'asc';
            } else if (sortStates[type][key] === 'asc') {
                sortStates[type][key] = 'desc';
            } else {
                sortStates[type][key] = 'asc';
                if (type === 'qiangchou') {
                    updateTable();
                } else if (type === 'pattern') {
                    updatePatternTable();
                }
                return;
            }
            
            const sortedData = [...data].sort((a, b) => {
                let aValue, bValue;
                
                if (type === 'pattern') {
                    switch(key) {
                        case 'index':
                            aValue = a.index || 0;
                            bValue = b.index || 0;
                            break;
                        case 'name':
                            aValue = a[1] + a[0];
                            bValue = b[1] + b[0];
                            break;
                        case 'bidIncrease':
                            aValue = parseFloat(a[4]) || 0;
                            bValue = parseFloat(b[4]) || 0;
                            break;
                        case 'currentIncrease':
                            aValue = parseFloat(a[5]) || 0;
                            bValue = parseFloat(b[5]) || 0;
                            break;
                        case 'industry':
                            aValue = a[7] || '';
                            bValue = b[7] || '';
                            break;
                        default:
                            return 0;
                    }
                } else {
                    switch(key) {
                        case 'index':
                            aValue = data.indexOf(a);
                            bValue = data.indexOf(b);
                            break;
                        case 'name':
                            aValue = a[1] + a[0];
                            bValue = b[1] + b[0];
                            break;
                        case 'bidIncrease':
                            aValue = parseFloat(a[4]) || 0;
                            bValue = parseFloat(b[4]) || 0;
                            break;
                        case 'currentIncrease':
                            aValue = parseFloat(a[5]) || 0;
                            bValue = parseFloat(b[5]) || 0;
                            break;
                        case 'industry':
                            aValue = a[7] || '';
                            bValue = b[7] || '';
                            break;
                        default:
                            return 0;
                    }
                }
                
                if (sortStates[type][key] === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            if (type === 'qiangchou') {
                currentData.qiangchou = sortedData;
                updateTable();
            } else if (type === 'pattern') {
                patternData = sortedData;
                updatePatternTable();
            }
            
            updateSortIcons(type, key, sortStates[type][key]);
        }

        function updateSortIcons(type, activeKey, direction) {
            let tableId;
            if (type === 'qiangchou') {
                tableId = 'qiangchouTable';
            } else if (type === 'pattern') {
                tableId = 'patternTable';
            } else {
                return;
            }
            
            const headers = document.querySelectorAll(`#${tableId} th[data-sort]`);
            
            headers.forEach(header => {
                const icon = header.querySelector('i');
                const key = header.getAttribute('data-sort');
                
                if (key === activeKey) {
                    icon.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    icon.className = 'fas fa-sort';
                }
            });
        }

        function showMessage(message, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${type}`;
            messageEl.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 14px;
                background-color: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#ffeaa7'};
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 280px;
                animation: slideIn 0.3s ease;
                font-size: 0.85rem;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.remove();
                        }
                    }, 300);
                }
            }, 3000);
            
            if (!document.querySelector('#message-styles')) {
                const styleEl = document.createElement('style');
                styleEl.id = 'message-styles';
                styleEl.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(styleEl);
            }
        }
    </script>
</body>
</html>
